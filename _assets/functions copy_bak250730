<?php
/**
 * @ Wordpress -> ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
 *
 */

// k01ã€œk06 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDé…åˆ—
function get_custom_users()
{
  return ['k01', 'k02', 'k03', 'k04', 'k05', 'k06'];
}

// ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ï¼ˆpost-k01ã€œpost-k06ï¼‰
function get_custom_post_types()
{
  return array_map(fn($user) => 'post-' . $user, get_custom_users());
}






//wp_headéƒ¨åˆ†ã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å‰Šé™¤ã™ã‚‹
remove_action('wp_head', 'wp_generator');

/* çµµæ–‡å­—è¡¨ç¤ºç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«å·®æ‰€ */
remove_action('wp_head', 'print_emoji_detection_script', 7);
remove_action('admin_print_scripts', 'print_emoji_detection_script');
remove_action('wp_print_styles', 'print_emoji_styles');
remove_action('admin_print_styles', 'print_emoji_styles');
add_filter('emoji_svg_url', '__return_false');

// EditURI å‰Šé™¤
remove_action('wp_head', 'rsd_link');
remove_action('wp_head', 'rest_output_link_wp_head');
remove_action('wp_head', 'wlwmanifest_link');
remove_action('wp_head', 'wp_shortlink_wp_head');
remove_action('wp_head', 'wp_oembed_add_discovery_links');
remove_action('wp_head', 'wp_oembed_add_host_js');

//ãƒ•ã‚£ãƒ¼ãƒ‰ã«ã‚‚WordPressã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å‡ºã•ãªã„
remove_action('rss2_head', 'the_generator');
remove_action('rss_head', 'the_generator');
remove_action('rdf_header', 'the_generator');
remove_action('atom_head', 'the_generator');

//wp_headã€wp_footerã‹ã‚‰è‡ªå‹•ã§åãå‡ºã•ã‚Œã‚‹CSSã¨JSã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’å‡ºã•ãªã„
function vc_remove_wp_ver_css_js($src)
{
  if (strpos($src, 'ver='))
    $src = remove_query_arg('ver', $src);
  return $src;
}
add_filter('style_loader_src', 'vc_remove_wp_ver_css_js', 9999);
add_filter('script_loader_src', 'vc_remove_wp_ver_css_js', 9999);

//wp_headãŒè‡ªå‹•ã§åãå‡ºã™ã€çµµæ–‡å­—è¡¨ç¤ºç”¨ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨ã‚¹ã‚¿ã‚¤ãƒ«ã®æƒãå‡ºã—ã‚’åœæ­¢
remove_action('wp_head', 'print_emoji_detection_script', 7);
remove_action('wp_print_styles', 'print_emoji_styles', 10);

//ã€ŒWordpressã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€ã‚’ã€ç®¡ç†è€…ä»¥å¤–ã«ã¯éè¡¨ç¤º
if (!current_user_can('edit_users')) {
  add_action('admin_menu', 'wphidenag');
  function wphidenag()
  {
    remove_action('admin_notices', 'update_nag', 3);
  }
}

//æŠ•ç¨¿è€…ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆ/?author=Xï¼‰ã‚’ç©ºæ¬„åŒ–
add_filter('author_rewrite_rules', '__return_empty_array');
//URLã‚’éè¡¨ç¤ºåŒ–
function disable_author_archive()
{
  if (isset($_GET['author']) || preg_match('#/author/.+#', $_SERVER['REQUEST_URI'])) {
    wp_redirect(home_url('/404.php'));
    exit;
  }
}
add_action('init', 'disable_author_archive');















/**
 * ãƒ†ãƒ¼ãƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 * å‚è€ƒï¼šhttps://wpdocs.osdn.jp/%E9%96%A2%E6%95%B0%E3%83%AA%E3%83%95%E3%82%A1%E3%83%AC%E3%83%B3%E3%82%B9/add_theme_support#HTML5
 **/
function my_setup()
{
  add_theme_support('post-thumbnails'); // ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒç”»åƒã‚’æœ‰åŠ¹åŒ–
  add_theme_support('automatic-feed-links'); // æŠ•ç¨¿ã¨ã‚³ãƒ¡ãƒ³ãƒˆã®RSSãƒ•ã‚£ãƒ¼ãƒ‰ã®ãƒªãƒ³ã‚¯ã‚’æœ‰åŠ¹åŒ–
  add_theme_support('title-tag'); // ã‚¿ã‚¤ãƒˆãƒ«ã‚¿ã‚°è‡ªå‹•ç”Ÿæˆ
  add_theme_support(
    'html5',
    array( //HTML5ã§ãƒãƒ¼ã‚¯ã‚¢ãƒƒãƒ—
      'search-form',
      'comment-form',
      'comment-list',
      'gallery',
      'caption',
    )
  );
}

add_action('after_setup_theme', 'my_setup');

/**
 * CSSã¨JavaScriptã®èª­ã¿è¾¼ã¿
 */
function my_script_init()
{
  wp_enqueue_style('fontawesome', 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css', array(), '6.4.0', 'all');


  wp_enqueue_style('my-slick-style', 'https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.css', array(), '1.8.1');

  wp_enqueue_style('my', get_template_directory_uri() . '/assets/css/style.css', array(), '1.0.0', 'all');
  wp_enqueue_style('status', get_template_directory_uri() . '/assets/css/appendix.css', array(), '1.0.0', 'all');



  wp_enqueue_script('jquery', 'https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js', array());




  wp_enqueue_script('my-slick-js', 'https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js', array(), '1.8.1', true);

  wp_enqueue_script('myscript', get_template_directory_uri() . '/assets/js/app.js', array());
  if (is_front_page()) {
    wp_enqueue_script('top_script', get_template_directory_uri() . '/assets/js/top.js', array());

  }
}
add_action('wp_enqueue_scripts', 'my_script_init');



/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ç™»éŒ²
 */

function my_menu_init()
{
  register_nav_menus(
    array(
      'header_menu' => 'ãƒ˜ãƒƒãƒ€ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼',
      'footer_menu01' => 'ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼01',
      'footer_menu02' => 'ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼02',
      'footer_menu03' => 'ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼03',
      'footer_menu04' => 'ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼04',
      'footer_menu-bottom' => 'ãƒ•ãƒƒã‚¿ãƒ¼ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœãƒˆãƒ ',
      // 'test_menu' => 'ãƒ†ã‚¹ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼',

    )
  );
}
add_action('init', 'my_menu_init');


//bodyã«slackã®ã‚¯ãƒ©ã‚¹åã‚’ã¤ã‘ã‚‹
add_filter('body_class', 'add_page_slug_class_name');
function add_page_slug_class_name($classes)
{
  if (is_page()) {
    $page = get_post(get_the_ID());
    $classes[] = $page->post_name;
  }
  return $classes;
}



/**
 * Gutenbergã®ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆè¨­å®š
 */
function aktk_editor_color_palette()
{
  add_theme_support('editor-color-palette', array(
    array(
      'name' => 'Main',
      'slug' => 'main',
      'color' => '#E95B3C',
    ),
    array(
      'name' => 'Accent',
      'slug' => 'accent',
      'color' => '#222',
    ),
    array(
      'name' => 'Gray',
      'slug' => 'gray',
      'color' => '#F2F3F1',
    ),
    array(
      'name' => 'Light Gray',
      'slug' => 'light-gray',
      'color' => '#efefef',
    ),
    array(
      'name' => 'Text',
      'slug' => 'text-black',
      'color' => '#000',
    ),
    array(
      'name' => 'White',
      'slug' => 'white',
      'color' => '#ffffff',
    ),
  ));
}

add_action('after_setup_theme', 'aktk_editor_color_palette');




//Snow Monkey Formsã§Google Analyticsã®ã‚³ãƒ³ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
//ãŠå•ã„åˆã‚ã›ãƒšãƒ¼ã‚¸
add_filter('snow_monkey_template_part_render_footer', function ($html, $name, $vars) {
  if (is_page('contact')) {
    $html .= "<script>
const form = document.querySelector( '.snow-monkey-form' )
form.addEventListener( 'smf.complete', ( event ) => gtag('event', 'form_contact_submit', {
  'event_category': 'form',
  'event_label': 'submit',
}))
</script>";
  }
  return $html;
}, 10, 3);

//æ±‚äººç”³ã—è¾¼ã¿ãƒšãƒ¼ã‚¸
add_filter('snow_monkey_template_part_render_footer', function ($html, $name, $vars) {
  if (is_page('recruit-form')) {
    $html .= "<script>
const form = document.querySelector( '.snow-monkey-form' )
form.addEventListener( 'smf.complete', ( event ) => gtag('event', 'form_recruit_submit', {
  'event_category': 'form',
  'event_label': 'submit',
}))
</script>";
  }
  return $html;
}, 10, 3);

//ã‚·ãƒ§ãƒ¼ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½¿ã£ãŸphpãƒ•ã‚¡ã‚¤ãƒ«ã®å‘¼ã³å‡ºã—æ–¹æ³•
function Include_my_php($params = array())
{
  extract(shortcode_atts(array(
    'file' => 'default'
  ), $params));
  ob_start();
  include(get_theme_root() . '/' . get_template() . "/template/$file.php");
  return ob_get_clean();
}
add_shortcode('myphp', 'Include_my_php');



//ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚¿ã‚¤ãƒ—ã®æ¨©é™ã‚’èª¿æ•´
add_filter('register_post_type_args', 'modify_post_type_capabilities', 10, 2);
function modify_post_type_capabilities($args, $post_type)
{

  if (in_array($post_type, get_custom_post_types(), true)) {
    $args['capability_type'] = $post_type;  // ä¾‹ï¼špost-k01
    $args['map_meta_cap'] = true;           // æ¨©é™ã‚’ç´°ã‹ãåˆ¶å¾¡ã§ãã‚‹ã‚ˆã†ã«
  }

  return $args;
}



//å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ­ãƒ¼ãƒ«ã‚’ä½œæˆ
function create_custom_roles_for_users()
{
  //get_custom_users()ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‘¼ã³å‡ºã—
  foreach (get_custom_users() as $user) {
    $post_type = 'post-' . $user;
    $role_name = $user . '_author';

    // æ—¢ã«ã‚ã‚Œã°å‰Šé™¤ï¼ˆå†è¨­å®šç”¨ï¼‰
    if (get_role($role_name)) {
      remove_role($role_name);
    }

    add_role($role_name, strtoupper($role_name), [
      // åŸºæœ¬ã®ç·¨é›†ãƒ»å…¬é–‹ãƒ»å‰Šé™¤æ¨©é™ï¼ˆè‡ªåˆ†ã®æŠ•ç¨¿ï¼‰
      "read" => true,
      "edit_{$post_type}" => true,
      "edit_{$post_type}s" => true,
      "edit_others_{$post_type}s" => false,
      "publish_{$post_type}s" => true,
      "delete_{$post_type}" => true,         // âœ… è‡ªåˆ†ã®æŠ•ç¨¿1ä»¶ã‚’å‰Šé™¤
      "delete_{$post_type}s" => true,        // âœ… è‡ªåˆ†ã®æŠ•ç¨¿ã‚’ä¸€è¦§ã‹ã‚‰å‰Šé™¤
      "delete_others_{$post_type}s" => false, // ğŸš« ä»–äººã®æŠ•ç¨¿ã¯å‰Šé™¤ä¸å¯

      // ãƒ¡ãƒ‡ã‚£ã‚¢ãƒ©ã‚¤ãƒ–ãƒ©ãƒªé–¢é€£
      "upload_files" => true,
      "delete_files" => true, // ä»»æ„ï¼šè‡ªåˆ†ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
      // å¿…é ˆ: WordPress UI ã®éƒ½åˆã§å¿…è¦ï¼ˆå®Ÿéš›ã«ã¯æŠ•ç¨¿ç·¨é›†æ¨©é™ãªã—ï¼‰
      "delete_posts" => true, // âœ… ã“ã‚Œã‚’ true ã«ã™ã‚‹ã®ãŒãƒã‚¤ãƒ³ãƒˆï¼
      // ä»–æŠ•ç¨¿ãƒ»å›ºå®šãƒšãƒ¼ã‚¸ã‚’ä¸€åˆ‡è§¦ã‚Œãªã„ã‚ˆã†ã«
      "edit_posts" => false,
      "edit_pages" => false,
      "delete_posts" => false,
      "delete_pages" => false,
      "publish_posts" => false,
      "publish_pages" => false,
    ]);
  }
}
add_action('init', 'create_custom_roles_for_users');

// å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å°‚ç”¨ãƒ­ãƒ¼ãƒ«ã‚’å‰²ã‚Šå½“ã¦
function assign_roles_to_custom_users()
{
  //get_custom_users()ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‘¼ã³å‡ºã—
  foreach (get_custom_users() as $user_login) {
    $user = get_user_by('login', $user_login);
    if ($user) {
      $user->set_role($user_login . '_author');
    }
  }
}
add_action('init', 'assign_roles_to_custom_users');


// ä»–äººã®ãƒ¡ãƒ‡ã‚£ã‚¢ã‚’è¡¨ç¤ºã—ãªã„
add_filter('ajax_query_attachments_args', 'filter_media_library_for_current_user');
function filter_media_library_for_current_user($query)
{
  // ç®¡ç†è€…ã«ã¯åˆ¶é™ã—ãªã„
  if (current_user_can('manage_options')) {
    return $query;
  }

  $user_id = get_current_user_id();
  if ($user_id) {
    $query['author'] = $user_id;
  }

  return $query;
}

// adminã«ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã®æ¨©é™ã‚’ä»˜ä¸
function add_caps_to_administrator()
{
  $role = get_role('administrator');
  if (!$role)
    return;
  //get_custom_post_types()ã§å…¨ã¦ã®ã‚«ã‚¹ã‚¿ãƒ æŠ•ç¨¿ã‚’å‘¼ã³å‡ºã—
  foreach (get_custom_post_types() as $pt) {
    $role->add_cap("edit_{$pt}");
    $role->add_cap("edit_{$pt}s");
    $role->add_cap("edit_others_{$pt}s");
    $role->add_cap("publish_{$pt}s");
    $role->add_cap("delete_{$pt}s");
    $role->add_cap("delete_others_{$pt}s");
    $role->add_cap("read_{$pt}");
    $role->add_cap("read_private_{$pt}s");
  }
}
add_action('init', 'add_caps_to_administrator');

// register_post_type('post-k01', array(
//   'label' => 'K01æŠ•ç¨¿',
//   'public' => true,
//   'show_ui' => true,
//   'capability_type' => array('post-k01', 'post-k01s'),
//   'map_meta_cap' => true,
//   'capabilities' => array(
//     'edit_post'           => 'edit_post-k01',
//     'read_post'           => 'read_post-k01',
//     'delete_post'         => 'delete_post-k01',
//     'edit_posts'          => 'edit_post-k01s',
//     'edit_others_posts'   => 'edit_others_post-k01s',
//     'publish_posts'       => 'publish_post-k01s',
//     'read_private_posts'  => 'read_private_post-k01s',
//     'delete_posts'        => 'delete_post-k01s',
//     'delete_others_posts' => 'delete_others_post-k01s',
//   ),
//   // ãã®ä»–ã®å¼•æ•°...
// ));

// add_action('init', function () {
//   $role = get_role('k01_author');
//   if ($role) {
//     $role->add_cap('edit_post-k01');
//     $role->add_cap('read_post-k01');
//     $role->add_cap('delete_post-k01');
//     $role->add_cap('edit_post-k01s');
//     $role->add_cap('edit_others_post-k01s');
//     $role->add_cap('publish_post-k01s');
//     $role->add_cap('read_private_post-k01s');
//     $role->add_cap('delete_post-k01s'); // â† ã“ã‚ŒãŒä¸€æ‹¬å‰Šé™¤ãªã©ã«å¿…è¦ï¼
//     $role->add_cap('delete_others_post-k01s');
//   }
// });

add_action('init', function () {
  // æ—¢å­˜ã® CPT ã‚’ä¸Šæ›¸ãç™»éŒ²ï¼ˆpost-k01ï¼‰
  register_post_type('post-k01', [
    'label' => 'Post K01',
    'public' => true,
    'show_ui' => true,
    'capability_type' => 'post-k01',
    'map_meta_cap' => true,
    'supports' => ['title', 'editor', 'author', 'thumbnail'],
    'capabilities' => [
      'edit_post' => 'edit_post-k01',
      'read_post' => 'read_post-k01',
      'delete_post' => 'delete_post-k01',
      'edit_posts' => 'edit_post-k01s',
      'edit_others_posts' => 'edit_others_post-k01s',
      'publish_posts' => 'publish_post-k01s',
      'read_private_posts' => 'read_private_post-k01s',
      'delete_posts' => 'delete_post-k01s',
      'delete_private_posts' => 'delete_private_post-k01s',
      'delete_published_posts' => 'delete_published_post-k01s',
      'delete_others_posts' => 'delete_others_post-k01s',
      'edit_private_posts' => 'edit_private_post-k01s',
      'edit_published_posts' => 'edit_published_post-k01s',
    ],
  ]);
}, 20); // ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚ˆã‚Šé…ãå®Ÿè¡Œã™ã‚‹ãŸã‚ã« priority ã‚’20ã«
